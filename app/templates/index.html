<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ title }}{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    {% block head %}{% endblock %}
</head>
<body>
    <header class="d-flex justify-content-center pt-4">
        <h1>La Météo d'Evelyn Del IA</h1>
    </header>

    <main class="container mt-3">
        {% block content %}
        <section class="container">
            <label for="inputTextRecognizer" class="form-label">Vos prédictions à la maison</label>
            <div id="textTranscription" class="form-text">
                Vous trouverez ci-dessous un bouton qui vous permettra alors d'activer votre micro. Avez-vous un micro de disponible. Est-il branché ?
            </div>
            <button id="startButton" class="btn btn-info border border-secondary mt-2">Cliquez ici et parlez</button>
        </section>
    
        <article id="results" class="container bg-info border border-secondary p-3 my-3">
            <div class="row justify-content-center">

            </div>
        </article>
        {% endblock %}
    </main>
    <script>
        document.getElementById('startButton').addEventListener('click', function() {
            fetch('/vocal-recognizer', { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    let resultsHTML = '';
                    const monitoringData = data;
                    if (data.localisations && data.localisations.length > 0) {
                        data.localisations.forEach(localisation => {
                            resultsHTML += `<div class="row mb-4">`;
                            resultsHTML += `<div class="col-12"><h3 class="text-center mb-3">${localisation}</h3></div>`;
                            Object.entries(data.dico_meteo[localisation]).forEach(([heure, infos]) => {
                                const tempCelsius = infos.main.temp - 273.15; // Conversion de Kelvin en Celsius
                                const description = infos.weather[0].description;
                                const iconCode = infos.weather[0].icon;
                                const iconUrl = `http://openweathermap.org/img/w/${iconCode}.png`;
                                resultsHTML += `
                                    <div class="col-md-4 d-flex align-items-stretch">
                                        <div class="card text-center bg-light border border-secondary">
                                            <div class="card-header">${heure}</div>
                                            <img src="${iconUrl}" class="card-img-top p-2" alt="Weather icon" style="width: 100px; height: auto; margin: 0 auto;">
                                            <div class="card-body">
                                                <h5 class="card-title">Température: ${tempCelsius.toFixed(2)}°C</h5>
                                                <p class="card-text">${description}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            resultsHTML += `</div>`;
                        });
                        resultsHTML += `
                        <form action="/soumission-data" method="post" id="feedback-form">
                            <div><label>Êtes-vous satisfait de la météo ?</label></div>
                            <div>
                                <input type="radio" id="satisfaitOui" name="isSatisfait" value="true" required>
                                <label for="satisfaitOui">Oui</label>
                                <input type="radio" id="satisfaitNon" name="isSatisfait" value="false" required>
                                <label for="satisfaitNon">Non</label>
                            </div>
                            <div>
                                <label for="commentaires">Commentaires (facultatif) :</label>
                                <input type="text" id="commentaires" name="commentaires">
                            </div>
                            <input type="hidden" id="monitoringData" name="monitoringData">
                            <div><button type="submit">Soumettre</button></div>
                        </form>
                    `;
                        document.getElementById('results').innerHTML = resultsHTML;
                        document.getElementById('monitoringData').value = JSON.stringify(monitoringData);
                        setupSubmit(monitoringData);
                    } else {
                        document.getElementById('results').innerHTML = '<p>Aucune donnée météo disponible.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('results').innerHTML = '<p>Erreur lors de la récupération des données météo.</p>';
                });
        });

        function setupSubmit(monitoringData) {
            const form = document.getElementById('feedback-form');
            if (form) {
                form.addEventListener('submit', async function(event) {
                        event.preventDefault();

                        const formData = new FormData(event.target);
                        const isSatisfait = formData.get('isSatisfait') === 'true';
                        const commentaires = formData.get('commentaires');
                        const monitoringData = JSON.parse(formData.get('monitoringData'));

    
                        const dataToSend = {
                        ...monitoringData,
                        isSatisfait: isSatisfait,
                        commentaires: commentaires,
                        };

                        try {
                            const response = await fetch('/soumission-data', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(dataToSend),
                        });
                        const result = await response.json();
                        console.log(result.message);
                    } catch (error) {
                        console.error('Erreur à la transmission de données :', error);
                    }
                });
            }
        }
    </script>
        
        
</body>
</html>